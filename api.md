# API Документация

## Эндпоинты для управления заказами клиентом в чате

### 1. Получение заказов клиента в чатах

**GET** `/api/chats/client-orders/`

Возвращает список заказов клиента в чатах с информацией о доступных действиях для управления статусом.

**Требования:**
- Аутентификация: обязательна
- Роль: клиент

**Ответ:**
```json
{
  "orders": [
    {
      "id": 1,
      "title": "Название заказа",
      "status": "in_progress",
      "status_label": "В работе",
      "budget": 15000,
      "deadline": "2024-01-15T00:00:00Z",
      "creator": {
        "id": 2,
        "username": "creator_username",
        "avatar": "url_to_avatar"
      },
      "target_creator": {
        "id": 2,
        "username": "creator_username", 
        "avatar": "url_to_avatar"
      },
      "chat_id": 1,
      "allowed_actions": ["cancel"],
      "action_labels": {
        "cancel": "Отменить"
      },
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z"
    }
  ],
  "count": 1
}
```

**Поля ответа:**
- `id` - ID заказа
- `title` - название заказа
- `status` - статус заказа (draft, published, awaiting_response, in_progress, on_review, completed, canceled)
- `status_label` - статус заказа на русском языке
- `budget` - бюджет заказа
- `deadline` - срок выполнения заказа
- `creator` - информация о креаторе чата
- `target_creator` - информация о назначенном исполнителе заказа
- `chat_id` - ID чата
- `allowed_actions` - список доступных действий для клиента
- `action_labels` - названия действий на русском языке
- `created_at` - дата создания заказа
- `updated_at` - дата последнего обновления заказа

### 2. Изменение статуса заказа клиентом

**POST** `/api/orders/{order_id}/client-change-status/`

Позволяет клиенту изменить статус своего заказа в зависимости от текущего состояния.

**Требования:**
- Аутентификация: обязательна
- Роль: клиент заказа

**Параметры URL:**
- `order_id` - ID заказа

**Тело запроса:**
```json
{
  "action": "cancel",
  "comment": "Причина изменения статуса (необязательно)"
}
```

**Доступные действия:**

#### Для статуса "draft" (Черновик):
- `cancel` - отменить заказ

#### Для статуса "published" (Опубликован):
- `cancel` - отменить заказ

#### Для статуса "awaiting_response" (Ожидает отклика):
- `cancel` - отменить заказ

#### Для статуса "in_progress" (В работе):
- `cancel` - отменить заказ

#### Для статуса "on_review" (На проверке):
- `cancel` - отменить заказ
- `complete` - принять работу (завершить заказ)
- `request_revision` - вернуть на доработку

#### Для статусов "completed" и "canceled":
- Никаких действий недоступно (финальные статусы)

**Ответ при успехе:**
```json
{
  "message": "Заказ отменен",
  "new_status": "canceled",
  "comment": "Причина изменения статуса"
}
```

**Ответ при ошибке:**
```json
{
  "error": "Действие \"complete\" недоступно для заказа в статусе \"in_progress\"",
  "allowed_actions": ["cancel"]
}
```

**Коды ответов:**
- `200` - успешное изменение статуса
- `400` - неверные параметры или недоступное действие
- `403` - нет прав доступа
- `404` - заказ не найден
- `500` - внутренняя ошибка сервера

### 3. Системные сообщения

При изменении статуса заказа автоматически создается системное сообщение в чате (если чат существует) с информацией об изменении и комментарием клиента (если указан).

Примеры системных сообщений:
- "Заказ отменен клиентом"
- "Заказ принят клиентом"
- "Заказ возвращен на доработку клиентом. Комментарий: Нужно изменить цвет логотипа"

### 4. Валидация переходов статусов

Система использует валидацию переходов статусов, определенную в модели Order:

```python
valid_transitions = {
    'draft': ['published', 'canceled'],
    'published': ['awaiting_response', 'in_progress', 'canceled'],
    'awaiting_response': ['in_progress', 'canceled'],
    'in_progress': ['on_review', 'canceled'],
    'on_review': ['in_progress', 'completed', 'canceled'],
    'completed': [],  # Финальный статус
    'canceled': ['draft']  # Можно восстановить только в черновик
}
```

Клиент может инициировать только определенные переходы в зависимости от текущего статуса заказа.